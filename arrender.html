<!--
    arrender.html code is adapted from the Three.js repo example here: https://github.com/mrdoob/three.js/blob/dev/examples/webxr_ar_cones.html
-->

<!DOCTYPE html>
<html lang="en">
    <head>
        <title>AR Render. Tap to Add Geometry</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <style>
            #arButton>button {
                background-color: DarkGreen !important;
                color: White;
            }
        </style>
    </head>
    <body>
        <div id ="arButton"></div>

        <!-- Import maps polyfill -->
        <!-- Remove this when import maps will be widely supported -->
        <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

        <script type="importmap">
            {
                "imports": {
                    "three": "../build/three.module.js",
                    "three/addons/": "./jsm/"
                }
            }
        </script>

        <script type="module">
            import * as THREE from 'three';
            import { ARButton } from 'three/addons/webxr/ARButton.js';

            let camera, scene, renderer, controller;
            let meshes = [];

            init();
            animate();

            function init() {
                const container = document.createElement('div');
                document.body.appendChild(container);

                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

                // Set up renderer
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.xr.enabled = true;
                container.appendChild(renderer.domElement);

                document.getElementById("arButton").appendChild(ARButton.createButton(renderer));

                // Geometry and material
                const largeCube = new THREE.BoxGeometry(.1, .1, .1);
                const smallCube = new THREE.BoxGeometry(0.025, 0.025, 0.025);
                const pinkMat = new THREE.MeshBasicMaterial({color: 0xd70b8e});
                const greenMat = new THREE.MeshBasicMaterial({color: 0x48eb02});

                // Screen tap
                function onSelect() {
                    var largeBody = new THREE.Mesh(largeCube, pinkMat);
                    var smallBody = new THREE.Mesh(smallCube, greenMat);
                    largeBody.position.set(0, 0, -0.5).applyMatrix4(controller.matrixWorld);
                    smallBody.position.set(0, 0, -0.25).applyMatrix4(controller.matrixWorld);
                    largeBody.quaternion.setFromRotationMatrix(controller.matrixWorld);
                    smallBody.quaternion.setFromRotationMatrix(controller.matrixWorld);
                    scene.add(largeBody);
                    scene.add(smallBody);
                    meshes.push(largeBody);
                    meshes.push(smallBody);
                }

                // Setup controller
                controller = renderer.xr.getController(0);
                controller.addEventListener('select', onSelect);
                scene.add(controller);
            }

            function animate() {
                renderer.setAnimationLoop(render);
            }

            function render() {
                renderer.render(scene, camera);
            }
        </script>
    </body>
</html>