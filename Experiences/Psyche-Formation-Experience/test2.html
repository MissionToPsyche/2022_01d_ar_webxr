<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Colliding Objects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.2.0/dist/aframe-extras.min.js"></script>
</head>
<body>
  <a-scene>
    <a-assets>
      <img id="crate-texture" src="https://cdn.glitch.com/745d1f92-80f3-4db3-b8d8-ec6b86291e91%2Fcrate-texture.jpg?v=1615861481827">
    </a-assets>
    <a-entity id="camera" position="0 1.6 0">
      <a-camera></a-camera>
    </a-entity>
    <a-box id="box1" class="collidable" position="2 0 -5" width="1" height="1" depth="1"
           material="src: #crate-texture;"></a-box>
    <a-box id="box2" class="collidable" position="2 0 -15" width="1" height="1" depth="1"
           color="red"></a-box>
    <a-plane position="0 0 -5" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
    <a-entity id="ground" geometry="primitive: plane" material="color: #CCC"
              position="0 -0.5 0" scale="100 1 100"
              static-body></a-entity>
  </a-scene>
  <script>
    var box1 = document.querySelector('#box1');
    var box2 = document.querySelector('#box2');
    var camera = document.querySelector('#camera');

    var direction = new THREE.Vector3();
    var distance = new THREE.Vector3();
    var force = new THREE.Vector3();

    var collisionHandler = function (event) {
      var targetEl = event.detail.body.el;
      if (targetEl !== camera) {
        targetEl.setAttribute('material', 'color', 'red');
      }
    };

    box1.setAttribute('velocity', { x: 0, y: 0, z: -2 });
    box1.setAttribute('dynamic-body', '');
    box2.setAttribute('velocity', { x: 0, y: 0, z: 2 });
    box2.setAttribute('dynamic-body', '');
    box1.addEventListener('collide', collisionHandler);
    box2.addEventListener('collide', collisionHandler);

    var tickHandler = function () {
      direction.copy(box2.getAttribute('position')).sub(box1.getAttribute('position'));
      distance.set(Math.abs(direction.x), Math.abs(direction.y), Math.abs(direction.z));
      if (distance.x < 1 && distance.y < 1 && distance.z < 1) {
        direction.multiplyScalar(-1);
        force.copy(direction).normalize().multiplyScalar(2);
        box1.body.applyForce(force.negate(), new CANNON.Vec3());
        box2.body.applyForce(force, new CANNON.Vec3());
      }
    };

    camera.addEventListener('collide', function (event) {
      var targetEl = event.detail.body
      if (targetEl.classList.contains('collidable')) {
    targetEl.setAttribute('material', 'color', 'red');
  }
});

AFRAME.registerComponent('move-box', {
  schema: {
    velocity: {type: 'vec3', default: {x: 0, y: 0, z: -1}},
  },

  tick: function (time, timeDelta) {
    var velocity = this.data.velocity;
    var position = this.el.getAttribute('position');
    position.x += velocity.x * timeDelta / 1000;
    position.y += velocity.y * timeDelta / 1000;
    position.z += velocity.z * timeDelta / 1000;
    this.el.setAttribute('position', position);
  }
});

box1.setAttribute('move-box', {velocity: {x: 0, y: 0, z: -2}});
box2.setAttribute('move-box', {velocity: {x: 0, y: 0, z: 2}});
camera.setAttribute('wasd-controls', '');

var sceneEl = document.querySelector('a-scene');
sceneEl.addEventListener('loaded', function () {
  sceneEl.addEventListener('tick', tickHandler);
});
</script>
</body>
</html>